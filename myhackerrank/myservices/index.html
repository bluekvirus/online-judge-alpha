<!DOCTYPE html>
<head>
	<title> Online Judge Prototype </title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.1/sketchy/bootstrap.min.css">
	<script src="lib/codemirror.js"></script>
	<link rel="stylesheet" href="lib/codemirror.css">
	<link rel="stylesheet" href="lib/theme/abcdef.css">
	<script src="lib/javascript/javascript.js"></script>
	<script src="lib/mode/python/python.js"></script>
	<script src="lib/mode/javascript/javascript.js"></script>
</head>
<body>
	<div id="front-end-container" style="position:absolute; top: 0; bottom: 0; right: 0; left: 0;"></div>
	<script>
		$(document).ready(function(){
			fetch('http://localhost:8000/judge/interview/0pOU3tKczExsAdCKl5pzwgNH6QTDXYGM3zvdYaW0hSx2oopvXB4ZFMnGzD9wgKXY/problems')
				.then((res) => {
			        return res.text();
				})
				.then((data) => {
				    var container = $('#front-end-container');
				    container.html(data);
				    startbtn = $('#start-btn');
				    if(startbtn.length > 0){
				    	startbtn.click(startInterview);
				    }else{
				    	//already started
			    		$('.submit-btn').click(submitProblem);
			    		$('.text').each(function(index, obj){
		    				var myCodeMirror = CodeMirror.fromTextArea(obj, {mode: {name:"python", version: 3} ,lineNumbers: true,  matchBrackets: true, styleActiveLine: true , theme: "abcdef", indentWithTabs: true});
		    				myCodeMirror.setSize(null, '100%');
		    				$codemirror = $(this).next('.CodeMirror')
		    				$codemirror.find('.CodeMirror-gutter').css('width', '29px')
		    				//$gutter.css('width', '29px');
		    				$codemirror.find('.CodeMirror-gutter-wrapper').css('left', '-31px');
		    				$sizer = $codemirror.find('.CodeMirror-sizer')
		    				$sizer.css('min-width', '7px')
		    				$sizer.css('margin-left', '31px')
		    				$line = $codemirror.find('.CodeMirror-linenumber').css('width', '21px');
		    				console.log("done making code mirror")
			    		});

		    			//$('[id^="sel_"]').change(function(){
		    			 $('[id^="sel"]').change(function(){
	    					editor = $(this).next('.text-pane').find('.CodeMirror')[0].CodeMirror;
			    			editor.setOption("mode", $(this).val());
			    		});
				    	preloadResults();

				    }
					
				});

		});

		function startInterview(){
 			fetch('http://localhost:8000/judge/interview/0pOU3tKczExsAdCKl5pzwgNH6QTDXYGM3zvdYaW0hSx2oopvXB4ZFMnGzD9wgKXY/start')
 				.then((res) =>{
	 				return res;
 				})
 				.then((data) => {
 					return fetch('http://localhost:8000/judge/interview/0pOU3tKczExsAdCKl5pzwgNH6QTDXYGM3zvdYaW0hSx2oopvXB4ZFMnGzD9wgKXY/problems');
 				})
				.then((res) => {
					return res.text();
				})
				.then((data) => {
					$('#front-end-container').html(data);
					$('.submit-btn').click(submitProblem);
					preloadResults();
				})
				.catch((error) =>{
					console.log(error);
				});	
		}

		function preloadResults(){
			$('.result-pane').each(function(i, obj){
				var obj = $(this);
				var url = 'http://localhost:8000/judge/interview/0pOU3tKczExsAdCKl5pzwgNH6QTDXYGM3zvdYaW0hSx2oopvXB4ZFMnGzD9wgKXY/results?pid=';
				url += obj.attr('data-problem-id');
				fetch(url).then((res) => {
					return res.json();
				}).then((data) => {
					//now convert the data into list elements and display
					$list = $('<ul class="reslist" style="list-style-type: none; padding: 0.5em;">');
					$(data).each(function(index, item){
						addToList($list, item.fields, true);
					});
					obj.append($list);
				});

			});
		}

		function addToList($list, item, flag){
			var $li = $('<li style="text-align:center;">');
			var $time = $('<span style = "padding-right: 2em; color: gray;">');
			var d = new Date(item['submit_at'])
			console.log(item['submit_at'])
			var offset = d.getTimezoneOffset();
			var hours = offset/60;
			d.setHours(d.getUTCHours() - hours);
			$time.text(d);
			var $result = $('<span style="color: gray">');
			$result.text(item['result']);
			$li.append($time);
			$li.append($result);
			if (flag){
				$list.append($li);
			}
			else{
				$list.prepend($li);
			}
			return $li
		}

		function submitProblem(event){
			var mydata = {}
			mydata['pid'] = event.target.getAttribute("data-problem-id");
			var $textpane = $('.text-pane[data-problem-id=' + mydata['pid'] + ']');
			editor = $textpane.find('.CodeMirror')[0].CodeMirror;
			mydata['code'] = editor.getValue();
			mode = editor.getMode().name;
			if(mode === "python"){
				mydata['language'] = "python3";
			}else{
				mydata['language'] = "javascript";
			}
			fetch('http://localhost:8000/judge/interview/0pOU3tKczExsAdCKl5pzwgNH6QTDXYGM3zvdYaW0hSx2oopvXB4ZFMnGzD9wgKXY/submit', {
				method: 'post',
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(mydata)
			}).then((res) => {
				return res.json();
			}).then((data) => {
				var flag = data.hasOwnProperty('Error');
				if(!flag){
					var $resultpane = $('.result-pane[data-problem-id=' + mydata['pid'] + ']');
					var $list = $resultpane.find('ul.reslist');
					var $li = addToList($list, data , false);
					if(data['result'] == "Queued" || data['result'] == "Processing"){
						//need to start polling until get result
						setTimeout(startPoll,2000, $li, mydata['pid'], data['submit_id']);
					}
				}	
			
			});
		}

		function startPoll($li, pid, sid){
			var url = 'http://localhost:8000/judge/interview/0pOU3tKczExsAdCKl5pzwgNH6QTDXYGM3zvdYaW0hSx2oopvXB4ZFMnGzD9wgKXY/poll?pid=';
			url += pid;
			url += "&sid=";
			url += sid;
			fetch(url).then((res) => {
				return res.json();
			}).then((data) => {
				if(data[0].fields['result'] == "Queued" || data[0].fields['result'] == "Processing"){
					setTimeout(startPoll,2000, $li, pid, sid);
				}else{
					$result = $li.find('span:last');
					$result.text(data[0].fields['result']);
				}
			});
		}
	</script>
</body>
</html>