<!DOCTYPE html>
<head>
	<title> Online Judge Prototype </title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.1/sketchy/bootstrap.min.css">
	<script src="lib/codemirror.js"></script>
	<link rel="stylesheet" href="lib/codemirror.css">
	<link rel="stylesheet" href="lib/theme/abcdef.css">
	<script src="lib/javascript/javascript.js"></script>
	<script src="lib/mode/python/python.js"></script>
	<script src="lib/mode/javascript/javascript.js"></script>
</head>
<body>
	<div id="front-end-container" style="position:absolute; top: 0; bottom: 0; right: 0; left: 0;"></div>
	<script>
		$(document).ready(function(){
			fetch('http://localhost:8000/judge/interview/nTT6hEPzgG1m7I4G5Mt9wcxPy22n1FLQmUbt8qfkW8pb2EJVTwvdG6e7RY8PcZNl/problems')
				.then((res) => {
			        return res.text();
				})
				.then((data) => {
				    var container = $('#front-end-container');
				    container.html(data);
				    startbtn = $('#start-btn');
				    if(startbtn.length > 0){
				    	startbtn.click(startInterview);
				    }else{
				    	//already started
			    		$('.submit-btn').click(submitProblem);
			    		//set up the cosmetic front end timer
			    		startTimer();
			    		$('.text').each(function(index, obj){
		    				var myCodeMirror = CodeMirror.fromTextArea(obj, {mode: {name:"python", version: 3} ,lineNumbers: true,  matchBrackets: true, styleActiveLine: true , theme: "abcdef", indentWithTabs: true});
		    				myCodeMirror.setSize(null, '100%');
		    				$codemirror = $(this).next('.CodeMirror');
		    				$codemirror.find('.CodeMirror-gutter').css('width', '29px');
		    				$codemirror.find('.CodeMirror-gutter-wrapper').css('left', '-31px');
		    				$sizer = $codemirror.find('.CodeMirror-sizer');
		    				$sizer.css('min-width', '7px');
		    				$sizer.css('margin-left', '31px');
		    				$line = $codemirror.find('.CodeMirror-linenumber').css('width', '21px');
			    		});

		    			 $('[id^="sel"]').change(function(){
	    					editor = $(this).next('.text-pane').find('.CodeMirror')[0].CodeMirror;
			    			editor.setOption("mode", $(this).val());
			    		});
				    	preloadResults();
				    }
					
				});

		});

		function startTimer(){
			fetch('http://localhost:8000/judge/interview/nTT6hEPzgG1m7I4G5Mt9wcxPy22n1FLQmUbt8qfkW8pb2EJVTwvdG6e7RY8PcZNl/time').then((res) =>{
					return res.json();
				}).then((data) => {
					if (data["Time"] == 0){
						//set time as zero, even if invalid already
						$('#timer').html('00:00:00');
					}
					//else figure out the correct time to display
					var startTime = new Date(data["Time"]);
					var currentTime = new Date();
				// console.log(currentTime);
				// var hours = currentTime.getHours() - startTime.getHours();
				// console.log("hours is: " + hours);
				// var minutes = currentTime.getMinutes() - startTime.getMinutes();
				// console.log("minutes is: " + minutes);
				// var seconds = currentTime.getSeconds() - startTime.getSeconds();
				// console.log("seconds is: " + seconds);
					var msdiff = Math.abs(currentTime - startTime);
					//we want to display 3 hours subtracting this msdiff to know how much time is left in the 3 hours
					var timeLeft = 3600000 - msdiff;
					var time = parseMillisecondsIntoReadableTime(timeLeft);
					$('#timer').html(time);
					setInterval(decrementTimer, 1000, timeLeft); //every 1 second
				})
		}

		function decrementTimer(timeLeft){
			var newtime = timeLeft - 1000;
			var time = parseMillisecondsIntoReadableTime(newtime);
			$('#timer').html(time);
			setInterval(decrementTimer, 1000, newtime);
		}

		function parseMillisecondsIntoReadableTime(milliseconds){
		  //Get hours from milliseconds
		  var hours = milliseconds / (1000*60*60);
		  var absoluteHours = Math.floor(hours);
		  var h = absoluteHours > 9 ? absoluteHours : '0' + absoluteHours;

		  //Get remainder from hours and convert to minutes
		  var minutes = (hours - absoluteHours) * 60;
		  var absoluteMinutes = Math.floor(minutes);
		  var m = absoluteMinutes > 9 ? absoluteMinutes : '0' +  absoluteMinutes;

		  //Get remainder from minutes and convert to seconds
		  var seconds = (minutes - absoluteMinutes) * 60;
		  var absoluteSeconds = Math.floor(seconds);
		  var s = absoluteSeconds > 9 ? absoluteSeconds : '0' + absoluteSeconds;

		  return h + ':' + m + ':' + s;
		}

		function startInterview(){
 			fetch('http://localhost:8000/judge/interview/nTT6hEPzgG1m7I4G5Mt9wcxPy22n1FLQmUbt8qfkW8pb2EJVTwvdG6e7RY8PcZNl/start')
 				.then((res) =>{
	 				return res;
 				})
 				.then((data) => {
 					return fetch('http://localhost:8000/judge/interview/nTT6hEPzgG1m7I4G5Mt9wcxPy22n1FLQmUbt8qfkW8pb2EJVTwvdG6e7RY8PcZNl/problems');
 				})
				.then((res) => {
					return res.text();
				})
				.then((data) => {
					$('#front-end-container').html(data);
					$('.submit-btn').click(submitProblem);
					preloadResults();
				})
				.catch((error) =>{
					console.log(error);
				});	
		}

		function preloadResults(){
			$('.result-pane').each(function(i, obj){
				var obj = $(this);
				var url = 'http://localhost:8000/judge/interview/nTT6hEPzgG1m7I4G5Mt9wcxPy22n1FLQmUbt8qfkW8pb2EJVTwvdG6e7RY8PcZNl/results?pid=';
				url += obj.attr('data-problem-id');
				fetch(url).then((res) => {
					return res.json();
				}).then((data) => {
					//now convert the data into list elements and display
					$list = $('<ul class="reslist" style="list-style-type: none;">');
					$(data).each(function(index, item){
						addToList($list, item.fields, true);
					});
					$div = $('<div style="float:left; width: 90%; text-align:center;">');
					$div.append($list);
					obj.append($div);
				});

			});
		}

		function addToList($list, item, flag){
			var $li = $('<li style="text-align:center;">');
			var $time = $('<span style = "padding-right: 2em; color: gray;">');
			var d = new Date(item['submit_at'])
			var offset = d.getTimezoneOffset();
			var hours = offset/60;
			d.setHours(d.getUTCHours() - hours);
			var newD = d.toString().split(' ').slice(0,5).join(' ');
			$time.text(newD);
			var $result = $('<span style="color: gray">');
			$result.text(item['result']);
			$li.append($time);
			$li.append($result);
			if (flag){
				$list.append($li);
			}
			else{
				$list.prepend($li);
			}
			return $li
		}

		function createModal(){

			var myvar = '<div class="modal" id="time-modal" tabindex="-1" role="dialog">'+
			'  <div class="modal-dialog" role="document">'+
			'    <div class="modal-content">'+
			'      <div class="modal-header">'+
			'        <h5 class="modal-title">Submission Error!</h5>'+
			'        <button type="button" class="close" data-dismiss="modal" aria-label="Close">'+
			'          <span aria-hidden="true">Ã—</span>'+
			'        </button>'+
			'      </div>'+
			'      <div class="modal-body">'+
			'        <p>Sorry, it seems that your interview session has ended. If you believe this is incorrect please contact the recruiter.</p>'+
			'      </div>'+
			'      <div class="modal-footer">'+
			'        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>'+
			'      </div>'+
			'    </div>'+
			'  </div>'+
			'</div>';
			$('body').append(myvar);
			$('#time-modal').modal();
			$('#time-modal').modal('show');

		}

		function submitProblem(event){
			var mydata = {}
			mydata['pid'] = event.target.getAttribute("data-problem-id");
			var $textpane = $('.text-pane[data-problem-id=' + mydata['pid'] + ']');
			editor = $textpane.find('.CodeMirror')[0].CodeMirror;
			mydata['code'] = editor.getValue();
			mode = editor.getMode().name;
			if(mode === "python"){
				mydata['language'] = "python3";
			}else{
				mydata['language'] = "javascript";
			}
			fetch('http://localhost:8000/judge/interview/nTT6hEPzgG1m7I4G5Mt9wcxPy22n1FLQmUbt8qfkW8pb2EJVTwvdG6e7RY8PcZNl/submit',{
				method: 'post',
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(mydata)
			}).then((res) => {
				return res.json();
			}).then((data) => {
				console.log(data)
				if(data.hasOwnProperty('Timeup')){
					//make a modal pop up interview has ended
					createModal();
				}
				else if(!data.hasOwnProperty('Error')){
					var $resultpane = $('.result-pane[data-problem-id=' + mydata['pid'] + ']');
					var $list = $resultpane.find('ul.reslist');
					var $li = addToList($list, data , false);
					if(data['result'] == "Queued" || data['result'] == "Processing"){
						//need to start polling until get result
						setTimeout(startPoll,2000, $li, mydata['pid'], data['submit_id']);
					}
				}	
			
			});
		}

		function startPoll($li, pid, sid){
			var url = 'http://localhost:8000/judge/interview/nTT6hEPzgG1m7I4G5Mt9wcxPy22n1FLQmUbt8qfkW8pb2EJVTwvdG6e7RY8PcZNl/poll?pid=';
			url += pid;
			url += "&sid=";
			url += sid;
			fetch(url).then((res) => {
				return res.json();
			}).then((data) => {
				if(data[0].fields['result'] == "Queued" || data[0].fields['result'] == "Processing"){
					setTimeout(startPoll,2000, $li, pid, sid);
				}else{
					$result = $li.find('span:last');
					$result.text(data[0].fields['result']);
				}
			});
		}
	</script>
</body>
</html>